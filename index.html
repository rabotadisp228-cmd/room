<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Roomix ‚Äî –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ Premium</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
--primary: #D4AF37;
--primary-dark: #B8941F;
--primary-light: rgba(212, 175, 55, 0.1);
--dark: #121212;
--dark-light: #1E1E1E;
--text: #FFFFFF;
--text-secondary: #B0B0B0;
--error: #FF6B6B;
--success: #4CAF50;
}

* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

html {
scroll-behavior: smooth;
background: var(--dark);
height: 100%;
}

body {
font-family: 'Montserrat', sans-serif;
background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 30%, #0f1419 60%, #1a1a1a 100%);
min-height: 100vh;
color: var(--text);
line-height: 1.6;
overflow-x: hidden;
-webkit-tap-highlight-color: transparent;
-webkit-text-size-adjust: 100%;
background-attachment: fixed;
background-repeat: no-repeat;
background-size: cover;
position: relative;
padding-bottom: env(safe-area-inset-bottom);
}

/* –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ–Ω —Å –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞–º–∏ */
body::before {
content: '';
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background:
    radial-gradient(circle at 20% 80%, rgba(212, 175, 55, 0.12) 0%, transparent 50%),
    radial-gradient(circle at 80% 20%, rgba(212, 175, 55, 0.08) 0%, transparent 50%),
    radial-gradient(circle at 50% 50%, rgba(76, 175, 80, 0.05) 0%, transparent 70%),
    radial-gradient(circle at 40% 40%, rgba(255, 255, 255, 0.03) 0%, transparent 50%);
z-index: 0;
animation: backgroundShift 20s ease-in-out infinite;
}

@keyframes backgroundShift {
0%, 100% {
    opacity: 1;
    transform: scale(1);
}
50% {
    opacity: 0.8;
    transform: scale(1.1);
}
}

/* –ü–ª–∞–≤–∞—é—â–∏–µ —á–∞—Å—Ç–∏—Ü—ã */
.particles {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
z-index: 1;
pointer-events: none;
overflow: hidden;
}

.particle {
position: absolute;
width: 4px;
height: 4px;
background: rgba(212, 175, 55, 0.5);
border-radius: 50%;
animation: float 20s infinite ease-in-out;
box-shadow: 0 0 10px rgba(212, 175, 55, 0.4);
}

.particle:nth-child(2n) {
background: rgba(76, 175, 80, 0.4);
box-shadow: 0 0 10px rgba(76, 175, 80, 0.4);
animation-duration: 25s;
}

.particle:nth-child(3n) {
background: rgba(255, 255, 255, 0.25);
box-shadow: 0 0 8px rgba(255, 255, 255, 0.25);
animation-duration: 30s;
width: 3px;
height: 3px;
}

@keyframes float {
0%, 100% {
    transform: translateY(0) translateX(0) rotate(0deg);
    opacity: 0;
}
10% {
    opacity: 1;
}
90% {
    opacity: 1;
}
50% {
    transform: translateY(-100vh) translateX(50px) rotate(180deg);
}
}

.container {
max-width: 1400px;
margin: 0 auto;
padding: 20px;
min-height: 100vh;
display: flex;
flex-direction: column;
position: relative;
z-index: 2;
}

header {
display: flex;
justify-content: space-between;
align-items: center;
padding: 20px 0;
margin-bottom: 30px;
width: 100%;
max-width: 100%;
flex-wrap: wrap;
gap: 15px;
}

.logo {
display: flex;
align-items: center;
gap: 15px;
text-decoration: none;
flex-shrink: 0;
transition: transform 0.3s ease;
}

.logo:hover {
transform: scale(1.05);
}

.logo:visited, .logo:hover, .logo:active {
text-decoration: none;
color: inherit;
}

.logo-icon {
width: 50px;
height: 50px;
background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
border-radius: 12px;
display: flex;
align-items: center;
justify-content: center;
color: var(--dark);
font-weight: 900;
font-size: 24px;
box-shadow: 
    0 4px 15px rgba(212, 175, 55, 0.4),
    0 0 20px rgba(212, 175, 55, 0.2);
flex-shrink: 0;
animation: logoGlow 3s ease-in-out infinite;
}

@keyframes logoGlow {
0%, 100% {
    box-shadow: 
        0 4px 15px rgba(212, 175, 55, 0.4),
        0 0 20px rgba(212, 175, 55, 0.2);
}
50% {
    box-shadow: 
        0 4px 20px rgba(212, 175, 55, 0.6),
        0 0 30px rgba(212, 175, 55, 0.4);
}
}

.logo-text {
font-size: 28px;
font-weight: 900;
background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
background-clip: text;
letter-spacing: 1px;
text-shadow: 0 0 30px rgba(212, 175, 55, 0.3);
}

.header-controls {
display: flex;
align-items: center;
gap: 20px;
flex-wrap: wrap;
justify-content: flex-end;
}

.language-selector {
position: relative;
display: inline-block;
}

.language-btn {
background: var(--primary-light);
color: var(--primary);
border: 1px solid rgba(255, 255, 255, 0.1);
border-radius: 10px;
padding: 10px 18px;
cursor: pointer;
display: flex;
align-items: center;
gap: 8px;
font-weight: 600;
transition: all 0.3s ease;
min-height: 44px;
backdrop-filter: blur(10px);
}

.language-btn:hover {
background: var(--primary);
color: var(--dark);
transform: translateY(-2px);
box-shadow: 0 5px 15px rgba(212, 175, 55, 0.3);
}

.language-dropdown {
display: none;
position: absolute;
top: 100%;
right: 0;
margin-top: 8px;
background: rgba(30, 30, 30, 0.95);
backdrop-filter: blur(20px);
border-radius: 12px;
padding: 10px 0;
min-width: 150px;
box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
z-index: 100;
border: 1px solid rgba(255, 255, 255, 0.1);
}

.language-dropdown.show {
display: block;
animation: dropdownSlide 0.3s ease;
}

@keyframes dropdownSlide {
from {
    opacity: 0;
    transform: translateY(-10px);
}
to {
    opacity: 1;
    transform: translateY(0);
}
}

.language-option {
padding: 12px 20px;
cursor: pointer;
transition: background 0.3s ease;
min-height: 44px;
display: flex;
align-items: center;
}

.language-option:hover {
background: rgba(255, 255, 255, 0.05);
}

.language-option.active {
color: var(--primary);
font-weight: 700;
background: rgba(212, 175, 55, 0.1);
}

.user-actions {
display: flex;
gap: 15px;
}

.btn-icon {
width: 44px;
height: 44px;
border-radius: 50%;
background: var(--primary-light);
display: flex;
align-items: center;
justify-content: center;
color: var(--primary);
backdrop-filter: blur(10px);
transition: all 0.3s ease;
}

.btn-icon:hover {
background: var(--primary);
color: var(--dark);
transform: translateY(-3px) scale(1.1);
box-shadow: 0 5px 20px rgba(212, 175, 55, 0.4);
}

.main-content {
display: grid;
grid-template-columns: 1.2fr 1fr;
gap: 40px;
margin-bottom: 40px;
flex: 1;
}

.card {
background: rgba(255, 255, 255, 0.05);
backdrop-filter: blur(30px);
-webkit-backdrop-filter: blur(30px);
border-radius: 24px;
padding: 30px;
border: 1px solid rgba(255, 255, 255, 0.1);
box-shadow:
    0 20px 60px rgba(0, 0, 0, 0.3),
    0 0 0 1px rgba(255, 255, 255, 0.05),
    inset 0 1px 0 rgba(255, 255, 255, 0.1);
transition: all 0.3s ease;
position: relative;
overflow: hidden;
}

.card::before {
content: '';
position: absolute;
top: 0;
left: -100%;
width: 100%;
height: 100%;
background: linear-gradient(90deg,
    transparent,
    rgba(255, 255, 255, 0.05),
    transparent);
transition: left 0.6s ease;
}

.card:hover::before {
left: 100%;
}

.card:hover {
transform: translateY(-8px);
box-shadow:
    0 25px 80px rgba(0, 0, 0, 0.4),
    0 0 0 1px rgba(255, 255, 255, 0.1),
    inset 0 1px 0 rgba(255, 255, 255, 0.15);
}

.card-header {
display: flex;
align-items: center;
margin-bottom: 25px;
padding-bottom: 15px;
border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.card-icon {
width: 40px;
height: 40px;
border-radius: 10px;
background: var(--primary-light);
display: flex;
align-items: center;
justify-content: center;
color: var(--primary);
margin-right: 15px;
font-size: 18px;
flex-shrink: 0;
}

.card-title {
font-size: 22px;
font-weight: 700;
color: var(--primary);
}

.form-grid {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 20px;
}

.form-group {
margin-bottom: 20px;
}

.form-group.full-width {
grid-column: 1 / -1;
}

label {
display: block;
margin-bottom: 8px;
font-weight: 600;
color: var(--text-secondary);
font-size: 14px;
}

.input-with-icon {
position: relative;
}

.input-icon {
position: absolute;
left: 15px;
top: 50%;
transform: translateY(-50%);
color: var(--primary);
z-index: 3;
pointer-events: none;
}

input, select {
width: 100%;
padding: 16px 16px 16px 45px;
border: 1px solid rgba(255, 255, 255, 0.1);
border-radius: 12px;
font-size: 16px;
background: rgba(255, 255, 255, 0.03);
color: var(--text);
transition: all 0.3s ease;
font-family: 'Montserrat', sans-serif;
min-height: 54px;
}

.input-with-icon select {
-webkit-appearance: none;
-moz-appearance: none;
appearance: none;
background: rgba(255, 255, 255, 0.03);
color: var(--text);
padding: 16px 40px 16px 45px;
border-radius: 12px;
border: 1px solid rgba(255,255,255,0.1);
z-index: 3;
position: relative;
}

.input-with-icon select::-ms-expand {
display: none;
}

.input-with-icon .select-arrow {
position: absolute;
right: 12px;
top: 50%;
transform: translateY(-50%);
color: var(--primary);
pointer-events: none;
z-index: 4;
font-size: 12px;
}

.input-with-icon select option {
background: var(--dark-light);
color: var(--text);
padding: 12px;
}

input:focus, select:focus {
outline: none;
border-color: var(--primary);
box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
}

input.error {
border-color: var(--error);
box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.2);
}

input.success {
border-color: var(--success);
box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
}

.error-msg {
color: var(--error);
font-size: 12px;
margin-top: 5px;
display: none;
}

.success-msg {
color: var(--success);
font-size: 12px;
margin-top: 5px;
display: none;
}

.gallery {
position: relative;
margin-bottom: 25px;
border-radius: 15px;
overflow: hidden;
height: 300px;
-webkit-user-select: none;
-moz-user-select: none;
-ms-user-select: none;
user-select: none;
}

.slides {
display: flex;
height: 100%;
transition: transform 0.5s ease;
-webkit-overflow-scrolling: touch;
}

.slide {
min-width: 100%;
height: 100%;
object-fit: contain;
object-position: center;
-webkit-user-drag: none;
-khtml-user-drag: none;
-moz-user-drag: none;
-o-user-drag: none;
user-drag: none;
background: var(--dark-light);
}

.gallery-nav {
position: absolute;
bottom: 20px;
left: 0;
right: 0;
display: flex;
justify-content: center;
gap: 10px;
z-index: 5;
}

.nav-dot {
width: 10px;
height: 10px;
border-radius: 50%;
background: rgba(255, 255, 255, 0.4);
cursor: pointer;
transition: all 0.3s ease;
}

.nav-dot.active {
background: var(--primary);
transform: scale(1.2);
}

.gallery-controls {
position: absolute;
top: 50%;
transform: translateY(-50%);
width: 100%;
display: flex;
justify-content: space-between;
padding: 0 20px;
opacity: 0;
transition: opacity 0.3s ease;
z-index: 5;
}

.gallery:hover .gallery-controls {
opacity: 1;
}

.gallery-btn {
width: 44px;
height: 44px;
border-radius: 50%;
background: rgba(0, 0, 0, 0.5);
display: flex;
align-items: center;
justify-content: center;
color: white;
cursor: pointer;
transition: all 0.3s ease;
}

.gallery-btn:hover {
background: var(--primary);
color: var(--dark);
}

.room-header {
display: flex;
justify-content: space-between;
align-items: flex-start;
margin-bottom: 15px;
flex-wrap: wrap;
gap: 15px;
}

.room-name {
font-size: 24px;
font-weight: 700;
color: var(--text);
margin-bottom: 5px;
line-height: 1.3;
}

.room-location {
color: var(--text-secondary);
font-size: 14px;
display: flex;
align-items: center;
gap: 5px;
}

.room-rating {
display: flex;
align-items: center;
gap: 5px;
background: var(--primary-light);
padding: 8px 12px;
border-radius: 20px;
color: var(--primary);
font-weight: 600;
flex-shrink: 0;
}

.room-price {
font-size: 28px;
font-weight: 700;
color: var(--primary);
margin: 20px 0;
display: flex;
align-items: center;
gap: 10px;
flex-wrap: wrap;
}

.price-period {
font-size: 14px;
color: var(--text-secondary);
font-weight: 400;
}

.room-description {
color: var(--text-secondary);
margin-bottom: 25px;
line-height: 1.7;
}

.amenities-grid {
display: grid;
grid-template-columns: repeat(3, 1fr);
gap: 15px;
margin-bottom: 25px;
}

.amenity {
display: flex;
align-items: center;
gap: 10px;
font-size: 14px;
}

.amenity-icon {
width: 30px;
height: 30px;
border-radius: 8px;
background: var(--primary-light);
display: flex;
align-items: center;
justify-content: center;
color: var(--primary);
flex-shrink: 0;
}

.booking-summary {
background: var(--primary-light);
border-radius: 15px;
padding: 20px;
margin-top: 20px;
}

.summary-row {
display: flex;
justify-content: space-between;
margin-bottom: 10px;
padding-bottom: 10px;
border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.summary-row:last-child {
border-bottom: none;
margin-bottom: 0;
padding-bottom: 0;
font-weight: 700;
font-size: 18px;
color: var(--primary);
}

.action-buttons {
display: grid;
grid-template-columns: 1fr;
gap: 15px;
margin-top: 30px;
}

.btn {
padding: 16px 24px;
border-radius: 12px;
font-size: 16px;
font-weight: 600;
cursor: pointer;
transition: all 0.3s ease;
display: flex;
align-items: center;
justify-content: center;
gap: 10px;
border: none;
font-family: 'Montserrat', sans-serif;
min-height: 54px;
-webkit-tap-highlight-color: transparent;
}

.btn-primary {
background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
color: var(--dark);
}

.btn-primary:hover {
transform: translateY(-3px);
box-shadow: 0 10px 20px rgba(212, 175, 55, 0.4);
}

.btn-secondary {
background: rgba(255, 255, 255, 0.05);
color: var(--text);
border: 1px solid rgba(255, 255, 255, 0.1);
}

.btn-secondary:hover {
background: rgba(255, 255, 255, 0.1);
transform: translateY(-3px);
}

.btn:disabled {
opacity: 0.6;
cursor: not-allowed;
transform: none !important;
box-shadow: none !important;
}

footer {
text-align: center;
padding: 30px 0;
margin-top: 40px;
border-top: 1px solid rgba(255, 255, 255, 0.1);
color: var(--text-secondary);
font-size: 14px;
flex-shrink: 0;
}

@keyframes fadeIn {
from { opacity: 0; transform: translateY(20px); }
to { opacity: 1; transform: translateY(0); }
}

.fade-in {
animation: fadeIn 0.5s ease forwards;
}

.delay-1 { animation-delay: 0.1s; }
.delay-2 { animation-delay: 0.2s; }
.delay-3 { animation-delay: 0.3s; }

@media (hover: none) {
.card:hover {
transform: none;
}

.btn:hover, .btn-icon:hover, .gallery-btn:hover {
transform: none;
}

.gallery-controls {
opacity: 1;
}
}

@media (max-width: 1200px) {
.container {
padding: 15px;
}

.main-content {
gap: 30px;
}
}

@media (max-width: 1024px) {
.main-content {
grid-template-columns: 1fr;
gap: 30px;
}

.amenities-grid {
grid-template-columns: repeat(2, 1fr);
}

.gallery {
height: 350px;
}
}

/* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —á–∞—Å—Ç–∏—Ü –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
@media (max-width: 768px) {
.particles {
    display: none; /* –û—Ç–∫–ª—é—á–∞–µ–º —á–∞—Å—Ç–∏—Ü—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ */
}
}

@media (max-width: 768px) {
.container {
padding: 15px;
}

header {
flex-direction: column;
gap: 20px;
padding: 15px 0;
text-align: center;
}

.logo {
justify-content: center;
width: 100%;
}

.header-controls {
width: 100%;
justify-content: center;
flex-direction: row;
gap: 15px;
}

.user-actions {
gap: 10px;
}

.btn-icon {
width: 44px;
height: 44px;
}

.card {
padding: 25px;
margin-bottom: 20px;
}

.form-grid {
grid-template-columns: 1fr;
}

.action-buttons {
grid-template-columns: 1fr;
}

.amenities-grid {
grid-template-columns: 1fr;
gap: 12px;
}

.room-header {
flex-direction: column;
gap: 15px;
align-items: flex-start;
}

.gallery {
height: 280px;
border-radius: 12px;
}

.room-name {
font-size: 22px;
}

.room-price {
font-size: 24px;
flex-direction: column;
align-items: flex-start;
gap: 5px;
}

.room-description {
font-size: 15px;
}

.amenity {
font-size: 14px;
}

input, select {
padding: 14px 14px 14px 45px;
font-size: 16px;
min-height: 50px;
}

.btn {
padding: 14px 20px;
font-size: 16px;
min-height: 50px;
}

.gallery-controls {
padding: 0 15px;
}

.gallery-btn {
width: 40px;
height: 40px;
}
}

@media (max-width: 480px) {
.container {
padding: 12px;
}

.logo-icon {
width: 44px;
height: 44px;
font-size: 20px;
}

.logo-text {
font-size: 24px;
}

.header-controls {
flex-direction: column;
gap: 12px;
}

.language-btn {
padding: 10px 15px;
font-size: 15px;
min-height: 44px;
}

.card {
padding: 20px;
border-radius: 16px;
}

.card-header {
margin-bottom: 20px;
padding-bottom: 12px;
}

.card-icon {
width: 36px;
height: 36px;
font-size: 16px;
}

.card-title {
font-size: 20px;
}

.gallery {
height: 220px;
margin-bottom: 20px;
border-radius: 12px;
}

.gallery-controls {
padding: 0 12px;
}

.gallery-btn {
width: 36px;
height: 36px;
}

.room-name {
font-size: 20px;
}

.room-rating {
font-size: 14px;
padding: 6px 10px;
}

.room-price {
font-size: 22px;
margin: 15px 0;
}

.room-description {
font-size: 14px;
margin-bottom: 20px;
}

.amenities-grid {
gap: 10px;
margin-bottom: 20px;
}

.amenity {
gap: 8px;
}

.amenity-icon {
width: 28px;
height: 28px;
font-size: 13px;
}

.booking-summary {
padding: 16px;
margin-top: 15px;
border-radius: 12px;
}

.summary-row {
font-size: 14px;
}

.summary-row:last-child {
font-size: 16px;
}

.form-group {
margin-bottom: 16px;
}

input, select {
padding: 12px 12px 12px 42px;
font-size: 16px;
border-radius: 10px;
min-height: 48px;
}

.input-icon {
left: 12px;
font-size: 16px;
}

.input-with-icon .select-arrow {
right: 10px;
font-size: 11px;
}

.btn {
padding: 14px 18px;
font-size: 16px;
border-radius: 10px;
min-height: 48px;
}

.error-msg, .success-msg {
font-size: 12px;
}

footer {
padding: 25px 0;
margin-top: 30px;
font-size: 13px;
}
}

@media (max-width: 360px) {
.container {
padding: 10px;
}

.logo-text {
font-size: 22px;
}

.card {
padding: 18px;
border-radius: 14px;
}

.gallery {
height: 200px;
}

.room-name {
font-size: 18px;
}

.room-price {
font-size: 20px;
}

input, select {
padding: 11px 11px 11px 40px;
font-size: 15px;
min-height: 46px;
}

.input-icon {
left: 11px;
font-size: 15px;
}

.btn {
padding: 13px 16px;
font-size: 15px;
min-height: 46px;
}
}

@supports (-webkit-touch-callout: none) {
input, select, .btn {
min-height: 44px;
}

.gallery {
-webkit-overflow-scrolling: touch;
}

body {
min-height: -webkit-fill-available;
}

html {
height: -webkit-fill-available;
}
}

@media screen and (-webkit-min-device-pixel-ratio: 0) {
select {
background: rgba(255, 255, 255, 0.03);
}
}

@media screen and (max-width: 768px) {
input, select, textarea {
font-size: 16px !important;
}
}

.loading-overlay {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(18, 18, 18, 0.95);
display: flex;
align-items: center;
justify-content: center;
z-index: 10000;
color: var(--primary);
font-size: 18px;
font-weight: 600;
flex-direction: column;
}

.loader {
border: 4px solid var(--primary-light);
border-top: 4px solid var(--primary);
border-radius: 50%;
width: 50px;
height: 50px;
animation: spin 1s linear infinite;
margin: 0 auto 20px;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

.error-message {
position: fixed;
top: 20px;
left: 50%;
transform: translateX(-50%);
background: #ff6b6b;
color: white;
padding: 15px 20px;
border-radius: 10px;
z-index: 10000;
font-weight: 600;
box-shadow: 0 5px 15px rgba(0,0,0,0.3);
max-width: 90%;
text-align: center;
}

::-webkit-scrollbar {
width: 0px;
background: transparent;
}

* {
scrollbar-width: none;
}

* {
-ms-overflow-style: none;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —á–∞—Ç–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ */
.support-chat {
position: fixed;
bottom: 30px;
right: 30px;
z-index: 1000;
}

.chat-toggle {
width: 60px;
height: 60px;
background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
border-radius: 50%;
display: flex;
align-items: center;
justify-content: center;
color: var(--dark);
font-size: 24px;
cursor: pointer;
box-shadow: 0 8px 25px rgba(212, 175, 55, 0.3);
transition: all 0.3s ease;
position: relative;
border: none;
}

.chat-toggle:hover {
transform: scale(1.1);
box-shadow: 0 12px 35px rgba(212, 175, 55, 0.4);
}

.chat-badge {
position: absolute;
top: -5px;
right: -5px;
background: var(--error);
color: white;
border-radius: 50%;
width: 20px;
height: 20px;
font-size: 12px;
display: flex;
align-items: center;
justify-content: center;
font-weight: 700;
}

.chat-modal {
position: fixed;
bottom: 80px;
right: 20px;
width: 380px;
height: 500px;
background: linear-gradient(135deg, var(--dark-light) 0%, rgba(30, 30, 30, 0.98) 100%);
border-radius: 20px;
border: 1px solid rgba(255, 255, 255, 0.1);
box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6), 0 0 0 1px rgba(255, 255, 255, 0.05);
backdrop-filter: blur(20px) saturate(180%);
display: none;
flex-direction: column;
overflow: hidden;
transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
z-index: 10001;
}

.chat-modal.active {
display: flex;
animation: chatSlideUp 0.3s ease;
}

@keyframes chatSlideUp {
from {
opacity: 0;
transform: translateY(20px);
}
to {
opacity: 1;
transform: translateY(0);
}
}

.chat-header {
background: linear-gradient(135deg, rgba(212, 175, 55, 0.15) 0%, rgba(212, 175, 55, 0.05) 100%);
padding: 20px;
border-bottom: 1px solid rgba(255, 255, 255, 0.1);
display: flex;
justify-content: space-between;
align-items: center;
position: relative;
}

.chat-header::before {
content: '';
position: absolute;
top: 0;
left: 0;
right: 0;
height: 2px;
background: linear-gradient(90deg, transparent, var(--primary), transparent);
opacity: 0.5;
}

.chat-title {
display: flex;
align-items: center;
gap: 10px;
font-weight: 600;
color: var(--primary);
font-size: 16px;
}

.chat-title i {
font-size: 18px;
}

.chat-close {
background: none;
border: none;
color: var(--text-secondary);
font-size: 18px;
cursor: pointer;
padding: 5px;
border-radius: 5px;
transition: all 0.3s ease;
}

.chat-close:hover {
color: var(--text);
background: rgba(255, 255, 255, 0.1);
}

.chat-messages {
flex: 1;
padding: 20px;
overflow-y: auto;
display: flex;
flex-direction: column;
gap: 15px;
scroll-behavior: smooth;
-webkit-overflow-scrolling: touch;
}

.chat-messages::-webkit-scrollbar {
width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
background: rgba(255, 255, 255, 0.03);
border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb {
background: linear-gradient(180deg, var(--primary), var(--primary-dark));
border-radius: 3px;
}

.chat-messages::-webkit-scrollbar-thumb:hover {
background: var(--primary);
}

.chat-message {
max-width: 85%;
padding: 12px 16px;
border-radius: 18px;
font-size: 14px;
line-height: 1.4;
word-wrap: break-word;
position: relative;
animation: messageSlideIn 0.3s ease-out;
box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.chat-message:hover {
transform: translateY(-2px);
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

@keyframes messageSlideIn {
from {
opacity: 0;
transform: translateY(10px);
}
to {
opacity: 1;
transform: translateY(0);
}
}

.message-client {
align-self: flex-end;
background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
color: var(--dark);
border-bottom-right-radius: 5px;
font-weight: 500;
}

.message-operator {
align-self: flex-start;
background: linear-gradient(135deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.08) 100%);
color: var(--text);
border-bottom-left-radius: 5px;
backdrop-filter: blur(10px);
border: 1px solid rgba(255, 255, 255, 0.1);
}

.message-reply-preview {
font-size: 12px;
opacity: 0.8;
padding: 8px;
border-left: 2px solid currentColor;
margin-bottom: 8px;
font-style: italic;
}

.message-time {
font-size: 11px;
opacity: 0.6;
margin-top: 5px;
text-align: right;
}

.chat-input-container {
padding: 20px;
background: linear-gradient(180deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.08) 100%);
border-top: 1px solid rgba(255, 255, 255, 0.1);
backdrop-filter: blur(10px);
position: sticky;
bottom: 0;
z-index: 10;
}

.reply-preview-box {
background: rgba(255, 255, 255, 0.05);
border-left: 3px solid var(--primary);
padding: 10px;
margin-bottom: 10px;
border-radius: 5px;
display: flex;
justify-content: space-between;
align-items: center;
font-size: 13px;
}

.reply-preview-text {
color: var(--text-secondary);
flex: 1;
overflow: hidden;
text-overflow: ellipsis;
white-space: nowrap;
}

.reply-clear-btn {
background: none;
border: none;
color: var(--text-secondary);
cursor: pointer;
padding: 5px;
font-size: 16px;
}

.reply-clear-btn:hover {
color: var(--text);
}

.chat-input-wrapper {
display: flex;
gap: 10px;
align-items: center;
}

#chatInput {
flex: 1;
padding: 12px 16px;
background: rgba(255, 255, 255, 0.08);
border: 1px solid rgba(255, 255, 255, 0.1);
border-radius: 25px;
color: var(--text);
font-size: 14px;
outline: none;
transition: all 0.3s ease;
font-family: 'Montserrat', sans-serif;
}

#chatInput:focus {
border-color: var(--primary);
background: rgba(255, 255, 255, 0.12);
}

#chatInput::placeholder {
color: var(--text-secondary);
}

.chat-send-btn {
width: 44px;
height: 44px;
background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
border: none;
border-radius: 50%;
color: var(--dark);
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
font-size: 16px;
box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
position: relative;
overflow: hidden;
}

.chat-send-btn::before {
content: '';
position: absolute;
top: 50%;
left: 50%;
width: 0;
height: 0;
border-radius: 50%;
background: rgba(255, 255, 255, 0.3);
transform: translate(-50%, -50%);
transition: width 0.6s, height 0.6s;
}

.chat-send-btn:hover:not(:disabled) {
transform: scale(1.1) rotate(5deg);
background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
box-shadow: 0 6px 20px rgba(212, 175, 55, 0.5);
}

.chat-send-btn:active:not(:disabled) {
transform: scale(0.95);
}

.chat-send-btn:active:not(:disabled)::before {
width: 300px;
height: 300px;
}

.chat-send-btn:disabled {
opacity: 0.5;
cursor: not-allowed;
transform: none;
}

.message-actions {
display: flex;
gap: 5px;
margin-top: 8px;
opacity: 0;
transition: opacity 0.3s ease;
}

.chat-message:hover .message-actions {
opacity: 1;
}

.message-action-btn {
background: rgba(255, 255, 255, 0.2);
border: none;
color: inherit;
cursor: pointer;
padding: 4px 8px;
border-radius: 4px;
font-size: 12px;
transition: all 0.3s ease;
}

.message-action-btn:hover {
background: rgba(255, 255, 255, 0.4);
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
@media (max-width: 768px) {
.support-chat {
bottom: 20px;
right: 20px;
}

.chat-toggle {
width: 56px;
height: 56px;
font-size: 22px;
box-shadow: 0 4px 12px rgba(212, 175, 55, 0.4);
}

.chat-toggle:active {
transform: scale(0.95);
}

.chat-modal {
position: fixed !important;
width: calc(100vw - 40px) !important;
max-width: 420px !important;
height: 75vh !important;
max-height: 600px !important;
min-height: 500px !important;
left: 50% !important;
right: auto !important;
bottom: 90px !important;
top: auto !important;
transform: translateX(-50%) !important;
border-radius: 24px !important;
box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7), 0 0 0 1px rgba(255, 255, 255, 0.1) !important;
margin: 0 !important;
padding: 0 !important;
z-index: 99999 !important;
}

.chat-modal.active {
transform: translateX(-50%) translateY(0) !important;
}

.chat-header {
padding: 20px 22px;
border-radius: 24px 24px 0 0;
}

.chat-title {
font-size: 16px;
}

.chat-messages {
padding: 20px;
gap: 14px;
}

.chat-message {
max-width: 80%;
padding: 14px 16px;
font-size: 15px;
border-radius: 20px;
}

.message-client {
border-bottom-right-radius: 6px;
}

.message-operator {
border-bottom-left-radius: 6px;
}

.chat-input-container {
padding: 18px 20px;
border-radius: 0 0 24px 24px;
position: sticky;
bottom: 0;
z-index: 10;
}

#chatInput {
padding: 14px 18px;
font-size: 15px;
border-radius: 25px;
}

.chat-send-btn {
width: 46px;
height: 46px;
font-size: 17px;
}
}

@media (max-width: 480px) {
.support-chat {
bottom: 15px;
right: 15px;
}

.chat-toggle {
width: 52px;
height: 52px;
font-size: 20px;
}

.chat-modal {
position: fixed !important;
width: calc(100vw - 30px) !important;
max-width: 100% !important;
height: 70vh !important;
max-height: 550px !important;
min-height: 450px !important;
left: 50% !important;
right: auto !important;
bottom: 80px !important;
top: auto !important;
transform: translateX(-50%) !important;
border-radius: 20px !important;
box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7), 0 0 0 1px rgba(255, 255, 255, 0.1) !important;
margin: 0 !important;
padding: 0 !important;
z-index: 99999 !important;
}

.chat-modal.active {
transform: translateX(-50%) translateY(0) !important;
}

.chat-header {
padding: 18px 20px;
border-radius: 20px 20px 0 0;
}

.chat-title {
font-size: 15px;
gap: 8px;
}

.chat-messages {
padding: 18px;
gap: 12px;
}

.chat-message {
max-width: 85%;
padding: 12px 14px;
font-size: 14px;
border-radius: 18px;
}

.chat-input-container {
padding: 16px 18px;
border-radius: 0 0 20px 20px;
position: sticky;
bottom: 0;
z-index: 10;
}

#chatInput {
padding: 12px 16px;
font-size: 14px;
}

.chat-send-btn {
width: 44px;
height: 44px;
font-size: 16px;
}

.reply-preview-box {
padding: 8px 12px;
font-size: 12px;
}
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è —á–∞—Ç–∞ */
.chat-modal.active {
opacity: 1;
visibility: visible;
transform: translateY(0) scale(1);
}

/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏ (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ) */
.typing-indicator {
display: flex;
gap: 4px;
padding: 12px 16px;
background: rgba(255, 255, 255, 0.05);
border-radius: 18px;
align-self: flex-start;
}

.typing-indicator span {
width: 8px;
height: 8px;
background: var(--text-secondary);
border-radius: 50%;
animation: typing 1.4s infinite;
}

.typing-indicator span:nth-child(2) {
animation-delay: 0.2s;
}

.typing-indicator span:nth-child(3) {
animation-delay: 0.4s;
}

@keyframes typing {
0%, 60%, 100% {
transform: translateY(0);
opacity: 0.5;
}
30% {
transform: translateY(-10px);
opacity: 1;
}
}
</style>
</head>
<body>
<div class="particles" id="particles"></div>

<div class="container">
<header>
<div class="logo">
<div class="logo-icon">R</div>
<div class="logo-text">Roomix</div>
</div>

<div class="header-controls">
<div class="language-selector">
<button class="language-btn">
<i class="fas fa-globe"></i>
<span id="currentLanguage">–†—É—Å—Å–∫–∏–π</span>
<i class="fas fa-chevron-down"></i>
</button>
<div class="language-dropdown" id="languageDropdown">
<div class="language-option active" data-lang="ru">–†—É—Å—Å–∫–∏–π</div>
<div class="language-option" data-lang="pl">Polski</div>
<div class="language-option" data-lang="en">English</div>
</div>
</div>

<div class="user-actions">
<div class="btn-icon">
<i class="fas fa-question-circle"></i>
</div>
<div class="btn-icon">
<i class="fas fa-bell"></i>
</div>
<div class="btn-icon">
<i class="fas fa-user"></i>
</div>
</div>
</div>
</header>

<div class="main-content">
<div class="card fade-in">
<div class="gallery">
<div class="slides" id="slides">
<!-- Images will be loaded dynamically -->
</div>

<div class="gallery-controls">
<div class="gallery-btn prev-btn">
<i class="fas fa-chevron-left"></i>
</div>
<div class="gallery-btn next-btn">
<i class="fas fa-chevron-right"></i>
</div>
</div>

<div class="gallery-nav" id="galleryNav">
<!-- Dots will be loaded dynamically -->
</div>
</div>

<div class="room-header">
<div>
<h3 class="room-name" id="roomName">–ü—Ä–µ–º–∏—É–º –õ—é–∫—Å —Å –≤–∏–¥–æ–º –Ω–∞ –≥–æ—Ä–æ–¥</h3>
<div class="room-location">
<i class="fas fa-map-marker-alt"></i> <span id="roomLocation">–í–∞—Ä—à–∞–≤–∞, –ü–æ–ª—å—à–∞</span>
</div>
</div>

<div class="room-rating">
<i class="fas fa-star"></i> <span id="roomRating">4.8</span>
</div>
</div>

<div class="room-price">
<span id="roomPrice">450</span> PLN <span class="price-period" id="pricePeriod">/ –∑–∞ –Ω–æ—á—å</span>
</div>

<p class="room-description" id="roomDescription">
–ü—Ä–æ—Å—Ç–æ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –ø—Ä–µ–º–∏—É–º-–∫–ª–∞—Å—Å–∞ —Å –ø–∞–Ω–æ—Ä–∞–º–Ω—ã–º –≤–∏–¥–æ–º –Ω–∞ –≥–æ—Ä–æ–¥. –í –Ω–æ–º–µ—Ä–µ –µ—Å—Ç—å king-size –∫—Ä–æ–≤–∞—Ç—å, —Ä–∞–±–æ—á–∞—è –∑–æ–Ω–∞, —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –≤–∞–Ω–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞ —Å –¥–∂–∞–∫—É–∑–∏. –ò–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç–¥—ã—Ö–∞ –∏–ª–∏ –¥–µ–ª–æ–≤–æ–π –ø–æ–µ–∑–¥–∫–∏.
</p>

<h4 style="margin-bottom: 15px; color: var(--text);" id="amenitiesTitle">–£–¥–æ–±—Å—Ç–≤–∞</h4>

<div class="amenities-grid" id="amenitiesGrid">
<!-- Amenities will be loaded dynamically -->
</div>

<div class="booking-summary">
<div class="summary-row">
<span id="nightsCount">450 PLN x 2 –Ω–æ—á–∏</span>
<span id="nightsPrice">900 PLN</span>
</div>

<div class="summary-row">
<span id="serviceFeeText">–°–±–æ—Ä –∑–∞ —É—Å–ª—É–≥–∏</span>
<span>50 PLN</span>
</div>

<div class="summary-row">
<span id="taxesText">–ù–∞–ª–æ–≥–∏</span>
<span>70 PLN</span>
</div>

<div class="summary-row">
<span id="totalText">–ò—Ç–æ–≥–æ</span>
<span id="totalPrice">1020 PLN</span>
</div>
</div>
</div>

<div class="card fade-in delay-1">
<div class="card-header">
<div class="card-icon">
<i class="fas fa-user-edit"></i>
</div>
<h2 class="card-title" id="formTitle">–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ</h2>
</div>

<form id="bookingForm">
<div class="form-grid">
<div class="form-group">
<label for="firstName" id="firstNameLabel">–ò–º—è</label>
<div class="input-with-icon">
<i class="fas fa-user input-icon"></i>
<input type="text" id="firstName" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è" required>
</div>
<div class="error-msg" id="firstNameError">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏–º—è</div>
</div>

<div class="form-group">
<label for="lastName" id="lastNameLabel">–§–∞–º–∏–ª–∏—è</label>
<div class="input-with-icon">
<i class="fas fa-user input-icon"></i>
<input type="text" id="lastName" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à—É —Ñ–∞–º–∏–ª–∏—é" required>
</div>
<div class="error-msg" id="lastNameError">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ñ–∞–º–∏–ª–∏—é</div>
</div>

<div class="form-group full-width">
<label for="email" id="emailLabel">Email</label>
<div class="input-with-icon">
<i class="fas fa-envelope input-icon"></i>
<input type="email" id="email" placeholder="example@mail.com" required>
</div>
<div class="error-msg" id="emailError">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email</div>
<div class="success-msg" id="emailSuccess">Email –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω</div>
</div>

<div class="form-group">
<label for="phone" id="phoneLabel">–¢–µ–ª–µ—Ñ–æ–Ω</label>
<div class="input-with-icon">
<i class="fas fa-phone input-icon"></i>
<input type="tel" id="phone" placeholder="+48 XXX XXX XXX" required>
</div>
<div class="error-msg" id="phoneError">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</div>
<div class="success-msg" id="phoneSuccess">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω</div>
</div>

<div class="form-group">
<label for="guests" id="guestsLabel">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π</label>
<div class="input-with-icon">
<i class="fas fa-users input-icon"></i>
<select id="guests">
<!-- Options will be loaded dynamically -->
</select>
<span class="select-arrow"><i class="fas fa-chevron-down"></i></span>
</div>
</div>

<div class="form-group">
<label for="checkIn" id="checkInLabel">–î–∞—Ç–∞ –∑–∞–µ–∑–¥–∞</label>
<div class="input-with-icon">
<i class="fas fa-calendar-day input-icon"></i>
<input type="date" id="checkIn" required>
</div>
</div>

<div class="form-group">
<label for="checkOut" id="checkOutLabel">–î–∞—Ç–∞ –≤—ã–µ–∑–¥–∞</label>
<div class="input-with-icon">
<i class="fas fa-calendar-day input-icon"></i>
<input type="date" id="checkOut" required>
</div>
</div>
</div>

<div class="action-buttons">
<button type="button" id="nextBtn" class="btn btn-primary" disabled style="grid-column: 1 / -1;">
–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ <i class="fas fa-arrow-right"></i>
</button>
</div>
</form>
</div>
</div>

<footer>
<p>¬© 2025 Roomix. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
<p style="margin-top: 10px; font-size: 12px;">–ü—Ä–∏–Ω–∏–º–∞–µ–º –∫ –æ–ø–ª–∞—Ç–µ:
<i class="fab fa-cc-visa" style="margin: 0 5px;"></i>
<i class="fab fa-cc-mastercard" style="margin: 0 5px;"></i>
<i class="fab fa-cc-paypal" style="margin: 0 5px;"></i>
</p>
</footer>
</div>

<!-- –ß–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ -->
<div class="support-chat">
<button class="chat-toggle" id="chatToggle">
<i class="fas fa-comments"></i>
<span class="chat-badge" id="chatBadge" style="display: none">1</span>
</button>

<div class="chat-modal" id="chatModal">
<div class="chat-header">
<div class="chat-title">
<i class="fas fa-headset"></i>
<span id="chatTitle">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</span>
</div>
<button class="chat-close" id="chatClose">
<i class="fas fa-times"></i>
</button>
</div>

<div class="chat-messages" id="chatMessages">
<!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
</div>

<div class="chat-input-container">
<div id="replyPreviewBox" class="reply-preview-box" style="display: none;">
<div class="reply-preview-text" id="replyPreviewText"></div>
<button type="button" class="reply-clear-btn" id="replyClearBtn">
<i class="fas fa-times"></i>
</button>
</div>

<div class="chat-input-wrapper">
<input type="text" id="chatInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." maxlength="500">
<button id="chatSend" class="chat-send-btn">
<i class="fas fa-paper-plane"></i>
</button>
</div>
</div>
</div>
</div>

<script>
// –î–∞–Ω–Ω—ã–µ –æ –Ω–æ–º–µ—Ä–µ
let roomData = {
name: "–ü—Ä–µ–º–∏—É–º –õ—é–∫—Å —Å –≤–∏–¥–æ–º –Ω–∞ –≥–æ—Ä–æ–¥",
location: "–í–∞—Ä—à–∞–≤–∞, –ü–æ–ª—å—à–∞",
price: 450,
rating: 4.8,
images: [
"https://images.unsplash.com/photo-1571896349842-33c89424de2d?auto=format&fit=crop&w=800&q=80",
"https://images.unsplash.com/photo-1566073771259-6a8506099945?auto=format&fit=crop&w=800&q=80",
"https://images.unsplash.com/photo-1582719478250-c89cae4dc85b?auto=format&fit=crop&w=800&q=80"
],
amenities: [
{ name: "wifi", icon: "wifi" },
{ name: "breakfast", icon: "utensils" },
{ name: "jacuzzi", icon: "hot-tub" },
{ name: "tv", icon: "tv" },
{ name: "ac", icon: "snowflake" },
{ name: "parking", icon: "parking" }
],
creatorTag: null
};

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Å—Å—ã–ª–∫–∏
function loadLinkData() {
const linkCode = getLinkCode();
if (linkCode) {
console.log('üîó –ö–æ–¥ —Å—Å—ã–ª–∫–∏:', linkCode);
// –°–æ—Ö—Ä–∞–Ω—è–µ–º link_code –≤ sessionStorage –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ payment.html
sessionStorage.setItem('currentLinkCode', linkCode);
loadDataFromAPI(linkCode);
} else {
console.log('‚ÑπÔ∏è –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –Ω–æ–º–µ—Ä');
updateRoomDisplay();
initSupportChat();
}
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–¥–∞ –∏–∑ —Ö–µ—à–∞
function getLinkCode() {
const hash = window.location.hash.substring(1);
if (hash && hash.match(/^[A-Z0-9]{6,}$/)) {
return hash;
}
const urlParams = new URLSearchParams(window.location.search);
const codeParam = urlParams.get('code');
if (codeParam && codeParam.match(/^[A-Z0-9]{6,}$/)) {
return codeParam;
}
return null;
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ API
function loadDataFromAPI(linkCode) {
showLoadingMessage();
const apiUrl = `https://roomix-production.up.railway.app/get_link_data/${linkCode}`;
const timeoutPromise = new Promise((_, reject) =>
setTimeout(() => reject(new Error('–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞')), 10000)
);

const fetchPromise = fetch(apiUrl)
.then(response => {
if (!response.ok) {
return response.text().then(text => {
throw new Error(`HTTP ${response.status}: ${text}`);
});
}
return response.json();
})
.then(data => {
if (data.error) {
throw new Error(data.error);
}
console.log('üì¶ –î–∞–Ω–Ω—ã–µ –æ—Ç API:', data);

if (data.link_name) roomData.name = data.link_name;
if (data.price) roomData.price = data.price;
if (data.country_city) roomData.location = data.country_city;
if (data.creator_tag) {
roomData.creatorTag = data.creator_tag;
console.log('üè∑Ô∏è –¢—ç–≥ —Å–æ–∑–¥–∞—Ç–µ–ª—è:', roomData.creatorTag);
}
if (data.images && data.images.length > 0) {
roomData.images = data.images;
}
if (data.description) {
roomData.description = data.description;
}
if (data.amenities && Array.isArray(data.amenities) && data.amenities.length > 0) {
roomData.amenities = data.amenities;
}

updateRoomDisplay();
updatePrice();
hideLoadingMessage();
initSupportChat();
});

Promise.race([fetchPromise, timeoutPromise])
.catch(error => {
console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
hideLoadingMessage();
let errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –Ω–æ–º–µ—Ä–∞';
if (error.message.includes('404')) {
errorMessage = '–°—Å—ã–ª–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞';
} else if (error.message.includes('500')) {
errorMessage = '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ';
} else if (error.message.includes('–¢–∞–π–º–∞—É—Ç')) {
errorMessage = '–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ';
}
showErrorMessage(`${errorMessage}. –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –Ω–æ–º–µ—Ä.`);
updateRoomDisplay();
initSupportChat();
});
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è UI
function showLoadingMessage() {
const loadingDiv = document.createElement('div');
loadingDiv.className = 'loading-overlay';
loadingDiv.innerHTML = `
<div style="text-align: center;">
<div class="loader"></div>
<div>–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–º–µ—Ä–∞...</div>
</div>
`;
document.body.appendChild(loadingDiv);
}

function hideLoadingMessage() {
const loadingDiv = document.querySelector('.loading-overlay');
if (loadingDiv) {
loadingDiv.remove();
}
}

function showErrorMessage(message) {
const errorDiv = document.createElement('div');
errorDiv.className = 'error-message';
errorDiv.textContent = message;
document.body.appendChild(errorDiv);
setTimeout(() => {
if (errorDiv.parentNode) {
errorDiv.remove();
}
}, 5000);
}

// –¢–µ–∫—Å—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —è–∑—ã–∫–æ–≤
const translations = {
ru: {
"roomDetails": "–î–µ—Ç–∞–ª–∏ –Ω–æ–º–µ—Ä–∞",
"yourData": "–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ",
"continue": "–ü–µ—Ä–µ–π—Ç–∏ –∫ –æ–ø–ª–∞—Ç–µ",
"back": "–ù–∞–∑–∞–¥",
"step1": "1. –î–∞–Ω–Ω—ã–µ –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è",
"step2": "2. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏ –æ–ø–ª–∞—Ç–∞",
"firstName": "–ò–º—è",
"lastName": "–§–∞–º–∏–ª–∏—è",
"email": "Email",
"phone": "–¢–µ–ª–µ—Ñ–æ–Ω",
"guests": "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π",
"checkIn": "–î–∞—Ç–∞ –∑–∞–µ–∑–¥–∞",
"checkOut": "–î–∞—Ç–∞ –≤—ã–µ–∑–¥–∞",
"enterFirstName": "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è",
"enterLastName": "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à—É —Ñ–∞–º–∏–ª–∏—é",
"enterEmail": "example@mail.com",
"enterPhone": "+48 XXX XXX XXX",
"firstNameError": "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∏–º—è",
"lastNameError": "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ñ–∞–º–∏–ª–∏—é",
"emailError": "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email",
"phoneError": "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞",
"emailSuccess": "Email –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω",
"phoneSuccess": "–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω",
"perNight": "/ –∑–∞ –Ω–æ—á—å",
"amenities": "–£–¥–æ–±—Å—Ç–≤–∞",
"serviceFee": "–°–±–æ—Ä –∑–∞ —É—Å–ª—É–≥–∏",
"taxes": "–ù–∞–ª–æ–≥–∏",
"total": "–ò—Ç–æ–≥–æ",
"nights": "–Ω–æ—á–∏",
"night": "–Ω–æ—á—å",
"guest": "–≥–æ—Å—Ç—å",
"guests_1": "–≥–æ—Å—Ç—è",
"guests_2": "–≥–æ—Å—Ç–µ–π",
"roomDescription": "–ü—Ä–æ—Å—Ç–æ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –ø—Ä–µ–º–∏—É–º-–∫–ª–∞—Å—Å–∞ —Å –ø–∞–Ω–æ—Ä–∞–º–Ω—ã–º –≤–∏–¥–æ–º –Ω–∞ –≥–æ—Ä–æ–¥. –í –Ω–æ–º–µ—Ä–µ –µ—Å—Ç—å king-size –∫—Ä–æ–≤–∞—Ç—å, —Ä–∞–±–æ—á–∞—è –∑–æ–Ω–∞, —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –≤–∞–Ω–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞ —Å –¥–∂–∞–∫—É–∑–∏. –ò–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç–¥—ã—Ö–∞ –∏–ª–∏ –¥–µ–ª–æ–≤–æ–π –ø–æ–µ–∑–¥–∫–∏.",
"wifi": "–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π Wi-Fi",
"breakfast": "–ó–∞–≤—Ç—Ä–∞–∫ –≤–∫–ª—é—á–µ–Ω",
"jacuzzi": "–î–∂–∞–∫—É–∑–∏",
"tv": "Smart TV",
"ac": "–ö–æ–Ω–¥–∏—Ü–∏–æ–Ω–µ—Ä",
"parking": "–ü–∞—Ä–∫–æ–≤–∫–∞",
"pool": "–ë–∞—Å—Å–µ–π–Ω",
"gym": "–¢—Ä–µ–Ω–∞–∂–µ—Ä–Ω—ã–π –∑–∞–ª",
"spa": "–°–ü–ê",
"bar": "–ë–∞—Ä",
"restaurant": "–†–µ—Å—Ç–æ—Ä–∞–Ω",
"roomService": "–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –≤ –Ω–æ–º–µ—Ä–∞—Ö",
"safe": "–°–µ–π—Ñ",
"minibar": "–ú–∏–Ω–∏-–±–∞—Ä",
"balcony": "–ë–∞–ª–∫–æ–Ω",
"view": "–í–∏–¥ –Ω–∞ –≥–æ—Ä–æ–¥"
},
pl: {
"roomDetails": "Szczeg√≥≈Çy pokoju",
"yourData": "Twoje dane",
"continue": "Przejd≈∫ do p≈Çatno≈õci",
"back": "Wstecz",
"step1": "1. Dane rezerwacji",
"step2": "2. Potwierdzenie i p≈Çatno≈õƒá",
"firstName": "Imiƒô",
"lastName": "Nazwisko",
"email": "Email",
"phone": "Telefon",
"guests": "Liczba go≈õci",
"checkIn": "Data zameldowania",
"checkOut": "Data wymeldowania",
"enterFirstName": "Wpisz swoje imiƒô",
"enterLastName": "Wpisz swoje nazwisko",
"enterEmail": "przyklad@mail.com",
"enterPhone": "+48 XXX XXX XXX",
"firstNameError": "Proszƒô podaƒá poprawne imiƒô",
"lastNameError": "Proszƒô podaƒá poprawne nazwisko",
"emailError": "Proszƒô podaƒá poprawny adres email",
"phoneError": "Proszƒô podaƒá poprawny numer telefonu",
"emailSuccess": "Email jest poprawny",
"phoneSuccess": "Numer telefonu jest poprawny",
"perNight": "/ za noc",
"amenities": "Udogodnienia",
"serviceFee": "Op≈Çata serwisowa",
"taxes": "Podatki",
"total": "Razem",
"nights": "noce",
"night": "noc",
"guest": "go≈õƒá",
"guests_1": "go≈õci",
"guests_2": "go≈õci",
"roomDescription": "Przestronny pok√≥j premium z panoramicznym widokiem na miasto. W pokoju znajduje siƒô ≈Ç√≥≈ºko king-size, strefa pracy, nowoczesna ≈Çazienka z jacuzzi. Idealny na romantyczny wypoczynek lub podr√≥≈º s≈Çu≈ºbowƒÖ.",
"wifi": "Darmowe Wi-Fi",
"breakfast": "≈öniadanie w cenie",
"jacuzzi": "Jacuzzi",
"tv": "Smart TV",
"ac": "Klimatyzacja",
"parking": "Parking",
"pool": "Basen",
"gym": "Si≈Çownia",
"spa": "SPA",
"bar": "Bar",
"restaurant": "Restauracja",
"roomService": "Serwis pokojowy",
"safe": "Sejf",
"minibar": "Mini-bar",
"balcony": "Balkon",
"view": "Widok na miasto"
},
en: {
"roomDetails": "Room Details",
"yourData": "Your Data",
"continue": "Proceed to Payment",
"back": "Back",
"step1": "1. Booking Data",
"step2": "2. Confirmation and Payment",
"firstName": "First Name",
"lastName": "Last Name",
"email": "Email",
"phone": "Phone",
"guests": "Number of Guests",
"checkIn": "Check-in Date",
"checkOut": "Check-out Date",
"enterFirstName": "Enter your first name",
"enterLastName": "Enter your last name",
"enterEmail": "example@mail.com",
"enterPhone": "+48 XXX XXX XXX",
"firstNameError": "Please enter a valid first name",
"lastNameError": "Please enter a valid last name",
"emailError": "Please enter a valid email",
"phoneError": "Please enter a valid phone number",
"emailSuccess": "Email is valid",
"phoneSuccess": "Phone number is valid",
"perNight": "/ per night",
"amenities": "Amenities",
"serviceFee": "Service Fee",
"taxes": "Taxes",
"total": "Total",
"nights": "nights",
"night": "night",
"guest": "guest",
"guests_1": "guests",
"guests_2": "guests",
"roomDescription": "Spacious premium room with panoramic city view. The room features a king-size bed, work area, modern bathroom with jacuzzi. Perfect for romantic getaway or business trip.",
"wifi": "Free Wi-Fi",
"breakfast": "Breakfast included",
"jacuzzi": "Jacuzzi",
"tv": "Smart TV",
"ac": "Air Conditioning",
"parking": "Parking",
"pool": "Swimming Pool",
"gym": "Fitness Center",
"spa": "SPA",
"bar": "Bar",
"restaurant": "Restaurant",
"roomService": "Room Service",
"safe": "Safe",
"minibar": "Minibar",
"balcony": "Balcony",
"view": "City View"
}
};

// –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —è–∑—ã–∫ –∏–∑ sessionStorage
let currentLanguage = sessionStorage.getItem('selectedLanguage') || 'ru';

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –Ω–æ–º–µ—Ä–µ
function updateRoomDisplay() {
document.getElementById('roomName').textContent = roomData.name;
document.getElementById('roomLocation').textContent = roomData.location;
document.getElementById('roomPrice').textContent = roomData.price;
document.getElementById('roomRating').textContent = roomData.rating;

const t = translations[currentLanguage];
let description = roomData.description || t.roomDescription;

if (roomData.creatorTag) {
description += `\n\nüîó –°—Å—ã–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∞: @${roomData.creatorTag}`;
console.log('‚úÖ –î–æ–±–∞–≤–ª—è–µ–º —Ç—ç–≥ —Å–æ–∑–¥–∞—Ç–µ–ª—è:', roomData.creatorTag);
}

document.getElementById('roomDescription').textContent = description;

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–∞–ª–µ—Ä–µ–∏
const slidesContainer = document.getElementById('slides');
const dotsContainer = document.getElementById('galleryNav');
slidesContainer.innerHTML = '';
dotsContainer.innerHTML = '';

if (roomData.images && roomData.images.length > 0) {
roomData.images.forEach((image, index) => {
const slide = document.createElement('img');
slide.className = 'slide';
slide.src = image;
slide.alt = `Room photo ${index + 1}`;
if (index === 0) slide.style.display = 'block';
slidesContainer.appendChild(slide);

const dot = document.createElement('div');
dot.className = `nav-dot ${index === 0 ? 'active' : ''}`;
dotsContainer.appendChild(dot);
});
} else {
const slide = document.createElement('img');
slide.className = 'slide';
slide.src = 'https://images.unsplash.com/photo-1571896349842-33c89424de2d?auto=format&fit=crop&w=800&q=80';
slide.alt = 'Room photo';
slide.style.display = 'block';
slidesContainer.appendChild(slide);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É–¥–æ–±—Å—Ç–≤ —Å —É—á–µ—Ç–æ–º —è–∑—ã–∫–∞
const amenitiesGrid = document.getElementById('amenitiesGrid');
amenitiesGrid.innerHTML = '';

// –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–¥–æ–±—Å—Ç–≤–∞ –∏–∑ roomData –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ
let amenitiesToDisplay = roomData.amenities;
if (!amenitiesToDisplay || !Array.isArray(amenitiesToDisplay) || amenitiesToDisplay.length === 0) {
// –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —É–¥–æ–±—Å—Ç–≤–∞
amenitiesToDisplay = [
{ name: "wifi", icon: "wifi" },
{ name: "breakfast", icon: "utensils" },
{ name: "jacuzzi", icon: "hot-tub" },
{ name: "tv", icon: "tv" },
{ name: "ac", icon: "snowflake" },
{ name: "parking", icon: "parking" }
];
}

amenitiesToDisplay.forEach(amenity => {
const amenityElement = document.createElement('div');
amenityElement.className = 'amenity';
const amenityName = translations[currentLanguage][amenity.name] || amenity.name;
amenityElement.innerHTML = `
<div class="amenity-icon">
<i class="fas fa-${amenity.icon}"></i>
</div>
<span>${amenityName}</span>
`;
amenitiesGrid.appendChild(amenityElement);
});

// –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–∞–ª–µ—Ä–µ–∏
initGallery();
}

// –õ–æ–∫–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã –¥–ª—è input[type=date]
function formatDateLocal(date) {
const y = date.getFullYear();
const m = String(date.getMonth() + 1).padStart(2, '0');
const d = String(date.getDate()).padStart(2, '0');
return `${y}-${m}-${d}`;
}

// –ü–∞—Ä—Å–µ—Ä –¥–∞—Ç—ã –∏–∑ input[type=date] –∫–∞–∫ –ª–æ–∫–∞–ª—å–Ω–∞—è –¥–∞—Ç–∞
function parseDateInputToLocal(value) {
if (!value) return null;
const parts = value.split('-').map(Number);
return new Date(parts[0], parts[1] - 1, parts[2]);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã
function saveFormData() {
const formData = {
firstName: document.getElementById('firstName').value,
lastName: document.getElementById('lastName').value,
email: document.getElementById('email').value,
phone: document.getElementById('phone').value
};
sessionStorage.setItem('formData', JSON.stringify(formData));
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞—Ç –∏ –¥–∞–Ω–Ω—ã—Ö
// –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞–≤–∞—é—â–∏—Ö —á–∞—Å—Ç–∏—Ü
function createParticles() {
    const particlesContainer = document.getElementById('particles');
    if (!particlesContainer) return;
    
    // –ù–µ —Å–æ–∑–¥–∞–µ–º —á–∞—Å—Ç–∏—Ü—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    if (window.innerWidth < 768) {
        return;
    }
    
    const particleCount = 30;
    
    for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.top = Math.random() * 100 + '%';
        particle.style.animationDelay = Math.random() * 20 + 's';
        particle.style.animationDuration = (20 + Math.random() * 10) + 's';
        particlesContainer.appendChild(particle);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    createParticles();
const savedLanguage = sessionStorage.getItem('selectedLanguage');
if (savedLanguage) {
currentLanguage = savedLanguage;
}

const today = new Date();
const tomorrow = new Date(today);
tomorrow.setDate(tomorrow.getDate() + 1);

document.getElementById('checkIn').value = formatDateLocal(today);
document.getElementById('checkOut').value = formatDateLocal(tomorrow);
document.getElementById('checkIn').min = formatDateLocal(today);
document.getElementById('checkOut').min = formatDateLocal(tomorrow);

loadLinkData();

updateRoomDisplay();
initLanguageSelector();
changeLanguage(currentLanguage);
updateGuestsSelect();
setupFormValidation();
updatePrice();

const savedFormData = sessionStorage.getItem('formData');
if (savedFormData) {
const formData = JSON.parse(savedFormData);
document.getElementById('firstName').value = formData.firstName || '';
document.getElementById('lastName').value = formData.lastName || '';
document.getElementById('email').value = formData.email || '';
document.getElementById('phone').value = formData.phone || '';

setTimeout(() => {
document.querySelectorAll('input').forEach(input => {
input.dispatchEvent(new Event('input'));
});
}, 100);
}
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞
function initLanguageSelector() {
const languageBtn = document.querySelector('.language-btn');
const languageDropdown = document.getElementById('languageDropdown');

languageBtn.addEventListener('click', function(event) {
event.stopPropagation();
languageDropdown.classList.toggle('show');
});

document.querySelectorAll('.language-option').forEach(option => {
option.addEventListener('click', function() {
const lang = this.getAttribute('data-lang');
changeLanguage(lang);
languageDropdown.classList.remove('show');
});
});

document.addEventListener('click', function(event) {
if (!languageBtn.contains(event.target) && !languageDropdown.contains(event.target)) {
languageDropdown.classList.remove('show');
}
});
}

// –°–º–µ–Ω–∞ —è–∑—ã–∫–∞
function changeLanguage(lang) {
currentLanguage = lang;
sessionStorage.setItem('selectedLanguage', lang);
const t = translations[lang];

document.getElementById('formTitle').textContent = t.yourData;
document.getElementById('firstNameLabel').textContent = t.firstName;
document.getElementById('lastNameLabel').textContent = t.lastName;
document.getElementById('emailLabel').textContent = t.email;
document.getElementById('phoneLabel').textContent = t.phone;
document.getElementById('guestsLabel').textContent = t.guests;
document.getElementById('checkInLabel').textContent = t.checkIn;
document.getElementById('checkOutLabel').textContent = t.checkOut;
document.getElementById('firstName').placeholder = t.enterFirstName;
document.getElementById('lastName').placeholder = t.enterLastName;
document.getElementById('email').placeholder = t.enterEmail;
document.getElementById('phone').placeholder = t.enterPhone;
document.getElementById('firstNameError').textContent = t.firstNameError;
document.getElementById('lastNameError').textContent = t.lastNameError;
document.getElementById('emailError').textContent = t.emailError;
document.getElementById('phoneError').textContent = t.phoneError;
document.getElementById('emailSuccess').textContent = t.emailSuccess;
document.getElementById('phoneSuccess').textContent = t.phoneSuccess;
document.getElementById('nextBtn').innerHTML = `${t.continue} <i class="fas fa-arrow-right"></i>`;

document.getElementById('pricePeriod').textContent = t.perNight;
document.getElementById('amenitiesTitle').textContent = t.amenities;
document.getElementById('serviceFeeText').textContent = t.serviceFee;
document.getElementById('taxesText').textContent = t.taxes;
document.getElementById('totalText').textContent = t.total;

document.getElementById('currentLanguage').textContent =
lang === 'ru' ? '–†—É—Å—Å–∫–∏–π' :
lang === 'pl' ? 'Polski' : 'English';

document.querySelectorAll('.language-option').forEach(option => {
option.classList.remove('active');
if (option.getAttribute('data-lang') === lang) {
option.classList.add('active');
}
});

updateGuestsSelect();
updatePrice();
updateRoomDisplay();
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≥–æ—Å—Ç–µ–π
function updateGuestsSelect() {
const t = translations[currentLanguage];
const guestsSelect = document.getElementById('guests');
const selectedValue = parseInt(guestsSelect.value || 2, 10);

guestsSelect.innerHTML = '';

for (let i = 1; i <= 4; i++) {
const option = document.createElement('option');
option.value = i;

if (i === 1) {
option.textContent = `${i} ${t.guest}`;
} else if (i < 5) {
option.textContent = `${i} ${t.guests_1}`;
} else {
option.textContent = `${i} ${t.guests_2}`;
}

if (i === selectedValue) {
option.selected = true;
}

guestsSelect.appendChild(option);
}
}

// –ì–∞–ª–µ—Ä–µ—è
function initGallery() {
const slides = document.querySelectorAll('.slide');
const dots = document.querySelectorAll('.nav-dot');
const prevBtn = document.querySelector('.prev-btn');
const nextBtn = document.querySelector('.next-btn');

let currentSlide = 0;

function showSlide(n) {
if (!slides.length) return;
slides.forEach(slide => slide.style.display = 'none');
dots.forEach(dot => dot.classList.remove('active'));

currentSlide = (n + slides.length) % slides.length;
slides[currentSlide].style.display = 'block';
if (dots[currentSlide]) dots[currentSlide].classList.add('active');
}

function nextSlide() {
showSlide(currentSlide + 1);
}

function prevSlide() {
showSlide(currentSlide - 1);
}

dots.forEach((dot, idx) => {
dot.addEventListener('click', () => showSlide(idx));
});

if (prevBtn) {
prevBtn.addEventListener('click', prevSlide);
}

if (nextBtn) {
nextBtn.addEventListener('click', nextSlide);
}

if (slides.length > 1) {
setInterval(nextSlide, 5000);
}

showSlide(0);
}

// –†–∞—Å—á–µ—Ç —Ü–µ–Ω—ã
function updatePrice() {
const checkInVal = document.getElementById('checkIn').value;
const checkOutVal = document.getElementById('checkOut').value;
const guests = parseInt(document.getElementById('guests').value || '1', 10);

const checkIn = parseDateInputToLocal(checkInVal);
const checkOut = parseDateInputToLocal(checkOutVal);

if (!checkIn || !checkOut) {
document.getElementById('nightsCount').textContent = `${roomData.price} PLN x 0 ${translations[currentLanguage].nights}`;
document.getElementById('nightsPrice').textContent = `0 PLN`;
document.getElementById('totalPrice').textContent = `0 PLN`;
return;
}

const msPerDay = 24 * 60 * 60 * 1000;
let nights = Math.floor((checkOut.getTime() - checkIn.getTime()) / msPerDay);
nights = Math.max(0, nights);

if (nights > 0) {
const pricePerNight = roomData.price;
const nightsTotal = pricePerNight * nights;
const serviceFee = 50;
const taxes = 70;
const total = nightsTotal + serviceFee + taxes;

const t = translations[currentLanguage];
const nightText = nights === 1 ? t.night : t.nights;

document.getElementById('nightsCount').textContent = `${pricePerNight} PLN x ${nights} ${nightText}`;
document.getElementById('nightsPrice').textContent = `${nightsTotal} PLN`;
document.getElementById('totalPrice').textContent = `${total} PLN`;

const bookingData = {
roomName: roomData.name,
pricePerNight: pricePerNight,
nights: nights,
total: total,
checkIn: checkInVal,
checkOut: checkOutVal,
guests: guests
};

sessionStorage.setItem('bookingData', JSON.stringify(bookingData));
sessionStorage.setItem('selectedLanguage', currentLanguage);
saveFormData();
} else {
const t = translations[currentLanguage];
document.getElementById('nightsCount').textContent = `${roomData.price} PLN x 0 ${t.nights}`;
document.getElementById('nightsPrice').textContent = `0 PLN`;
document.getElementById('totalPrice').textContent = `0 PLN`;
}
}

// –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
function setupFormValidation() {
const form = document.getElementById('bookingForm');
const inputs = form.querySelectorAll('input[required]');
const nextBtn = document.getElementById('nextBtn');

document.getElementById('phone').addEventListener('input', function(e) {
this.value = this.value.replace(/[^\d+]/g, '');
saveFormData();
});

function validateForm() {
let isValid = true;

inputs.forEach(input => {
const value = input.value.trim();
let fieldValid = true;

if (!value) {
fieldValid = false;
} else if (input.type === 'email' && !isValidEmail(value)) {
fieldValid = false;
} else if (input.id === 'phone' && !isValidPhone(value)) {
fieldValid = false;
} else if ((input.id === 'firstName' || input.id === 'lastName') && !isValidName(value)) {
fieldValid = false;
}

const errorMsg = document.getElementById(`${input.id}Error`);
const successMsg = document.getElementById(`${input.id}Success`);

if (input.id === 'email' || input.id === 'phone') {
if (fieldValid && value) {
input.classList.remove('error');
input.classList.add('success');
if (errorMsg) errorMsg.style.display = 'none';
if (successMsg) successMsg.style.display = 'block';
} else if (!fieldValid && value) {
input.classList.remove('success');
input.classList.add('error');
if (errorMsg) errorMsg.style.display = 'block';
if (successMsg) successMsg.style.display = 'none';
} else {
input.classList.remove('error', 'success');
if (errorMsg) errorMsg.style.display = 'none';
if (successMsg) successMsg.style.display = 'none';
}
} else {
if (!fieldValid && value) {
input.classList.add('error');
if (errorMsg) errorMsg.style.display = 'block';
} else {
input.classList.remove('error');
if (errorMsg) errorMsg.style.display = 'none';
}
}

if (!fieldValid) isValid = false;
});

const checkIn = parseDateInputToLocal(document.getElementById('checkIn').value);
const checkOut = parseDateInputToLocal(document.getElementById('checkOut').value);

if (checkIn && checkOut && checkOut <= checkIn) {
isValid = false;
alert(currentLanguage === 'ru' ?
'–î–∞—Ç–∞ –≤—ã–µ–∑–¥–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–∑–∂–µ –¥–∞—Ç—ã –∑–∞–µ–∑–¥–∞' :
currentLanguage === 'pl' ?
'Data wymeldowania musi byƒá p√≥≈∫niejsza ni≈º data zameldowania' :
'Check-out date must be after check-in date');
}

nextBtn.disabled = !isValid;
return isValid;
}

function isValidEmail(email) {
const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
return re.test(email);
}

function isValidPhone(phone) {
const re = /^(\+48)?\d{9}$/;
return re.test(phone.replace(/\s/g, ''));
}

function isValidName(name) {
const re = /^[a-zA-Z–∞-—è–ê-–Ø—ë–Å\s\-]+$/;
return re.test(name);
}

document.getElementById('checkIn').addEventListener('change', function() {
const checkInDate = parseDateInputToLocal(this.value);
const nextDay = new Date(checkInDate);
nextDay.setDate(nextDay.getDate() + 1);
document.getElementById('checkOut').min = formatDateLocal(nextDay);

const checkOutDate = parseDateInputToLocal(document.getElementById('checkOut').value);
if (!checkOutDate || checkOutDate <= checkInDate) {
document.getElementById('checkOut').value = formatDateLocal(nextDay);
}

validateForm();
updatePrice();
saveFormData();
});

document.getElementById('checkOut').addEventListener('change', function() {
validateForm();
updatePrice();
saveFormData();
});

document.getElementById('guests').addEventListener('change', function() {
validateForm();
updatePrice();
saveFormData();
});

inputs.forEach(input => {
input.addEventListener('input', function() {
validateForm();
saveFormData();
});

input.addEventListener('change', function() {
validateForm();
saveFormData();
});
});

nextBtn.addEventListener('click', function() {
if (!this.disabled) {
saveFormData();
updatePrice();
window.location.href = 'payment.html';
}
});
}

// –ß–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ä–µ–ø–ª–∞–µ–≤
class SupportChat {
constructor() {
// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –£–ù–ò–ö–ê–õ–¨–ù–´–ô chatKey –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
// –ö–æ–º–±–∏–Ω–∞—Ü–∏—è: linkCode + —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
const linkCode = getLinkCode();
this.linkCode = linkCode; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è —Å–≤—è–∑–∏ —Å –≤–æ—Ä–∫–µ—Ä–æ–º

// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –ø–æ—Å–µ—â–µ–Ω–∏–∏)
let uniqueUserId = sessionStorage.getItem('uniqueChatUserId');
if (!uniqueUserId) {
// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID: timestamp + random + linkCode (–µ—Å–ª–∏ –µ—Å—Ç—å)
const randomPart = Math.random().toString(36).substr(2, 12);
const timestamp = Date.now();
uniqueUserId = `chat_${timestamp}_${randomPart}`;
if (linkCode) {
uniqueUserId += `_${linkCode}`;
}
sessionStorage.setItem('uniqueChatUserId', uniqueUserId);
}

// –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∫–∞–∫ chatKey
this.chatKey = uniqueUserId;

this.isConnected = false;
this.eventSource = null;
this.reconnectAttempts = 0;
this.reconnectTimeout = null;
this.heartbeatInterval = null;
this.lastHeartbeat = null;
this.selectedReplyId = null;
this.messages = [];
this.init();
}

generateFallbackId() {
// –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
let userId = sessionStorage.getItem('chatUserId');
if (!userId) {
userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
sessionStorage.setItem('chatUserId', userId);
}
return userId;
}

init() {
this.bindEvents();
this.loadChatHistory();
this.loadMessagesFromStorage();
this.connectSSE();
this.setupPageEvents();
this.startHeartbeat();
}

bindEvents() {
const chatToggle = document.getElementById('chatToggle');
const chatClose = document.getElementById('chatClose');
const chatSend = document.getElementById('chatSend');
const chatInput = document.getElementById('chatInput');
const replyClearBtn = document.getElementById('replyClearBtn');
const chatMessages = document.getElementById('chatMessages');

chatToggle.addEventListener('click', () => this.toggleChat());
chatClose.addEventListener('click', () => this.closeChat());
chatSend.addEventListener('click', () => this.sendMessage());
replyClearBtn.addEventListener('click', () => this.clearReply());

// –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–û—Ç–≤–µ—Ç–∏—Ç—å" (—Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π)
if (chatMessages) {
chatMessages.addEventListener('click', (e) => {
const replyBtn = e.target.closest('.message-action-btn');
if (replyBtn) {
e.preventDefault();
e.stopPropagation();
const messageId = replyBtn.getAttribute('data-reply-id');
const messageDiv = replyBtn.closest('.chat-message');
if (messageDiv) {
const messageText = messageDiv.querySelector('.message-text')?.textContent || '';
this.setReply(messageId, messageText);
}
}
});
}

chatInput.addEventListener('keypress', (e) => {
if (e.key === 'Enter') {
this.sendMessage();
}
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
chatInput.addEventListener('focus', () => {
setTimeout(() => {
this.scrollToBottom();
// –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –≤–∏–¥–∏–º—É—é –æ–±–ª–∞—Å—Ç—å
const chatInputContainer = document.querySelector('.chat-input-container');
if (chatInputContainer) {
chatInputContainer.scrollIntoView({ behavior: 'smooth', block: 'end' });
}
// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –¥–ª—è —á–∞—Ç–∞
const chatMessages = document.getElementById('chatMessages');
if (chatMessages) {
setTimeout(() => {
chatMessages.scrollTop = chatMessages.scrollHeight;
}, 300);
}
}, 100);
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
chatInput.addEventListener('blur', () => {
setTimeout(() => {
this.scrollToBottom();
}, 100);
});

document.addEventListener('click', (e) => {
const chatModal = document.getElementById('chatModal');
const chatToggle = document.getElementById('chatToggle');
if (!chatModal.contains(e.target) && !chatToggle.contains(e.target) && chatModal.classList.contains('active')) {
this.closeChat();
}
});
}

toggleChat() {
const chatModal = document.getElementById('chatModal');
chatModal.classList.toggle('active');
if (chatModal.classList.contains('active')) {
this.hideBadge();
this.scrollToBottom();
setTimeout(() => {
document.getElementById('chatInput').focus();
}, 300);
}
}

closeChat() {
const chatModal = document.getElementById('chatModal');
chatModal.classList.remove('active');
}

async sendMessage() {
const chatInput = document.getElementById('chatInput');
const message = chatInput.value.trim();

if (!message) return;

this.addMessage(message, 'client', null, this.selectedReplyId);
chatInput.value = '';
this.clearReply();
chatInput.focus();

try {
// –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π linkCode
const linkCode = this.linkCode || getLinkCode();

const payload = {
user_id: this.chatKey,  // –ò—Å–ø–æ–ª—å–∑—É–µ–º user_id –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
chat_key: this.chatKey,
sender: 'client',
message: message,
timestamp: new Date().toISOString()
};

// –î–æ–±–∞–≤–ª—è–µ–º link_code –µ—Å–ª–∏ –µ—Å—Ç—å
if (linkCode) {
payload.link_code = linkCode;
// –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–≤—è–∑—å –º–µ–∂–¥—É chat_key –∏ link_code –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤–æ—Ä–∫–µ—Ä–∞
await fetch('https://roomix-production.up.railway.app/save_chat_mapping', {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify({
chat_user_id: this.chatKey,
link_code: linkCode
})
});
}

if (this.selectedReplyId) {
payload.reply_to_message_id = this.selectedReplyId;
}

const response = await fetch('https://roomix-production.up.railway.app/send_chat_message', {
method: 'POST',
headers: {
'Content-Type': 'application/json',
},
body: JSON.stringify(payload)
});

if (!response.ok) {
throw new Error(`HTTP ${response.status}`);
}

const result = await response.json();
console.log('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:', result);
} catch (error) {
console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
this.addSystemMessage('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
}
}

addMessage(text, sender, messageId = null, replyToId = null) {
const chatMessages = document.getElementById('chatMessages');
const messageDiv = document.createElement('div');
messageDiv.className = `chat-message message-${sender}`;
messageDiv.dataset.messageId = messageId || Date.now();

const time = new Date().toLocaleTimeString('ru-RU', {
hour: '2-digit',
minute: '2-digit'
});

let replyPreview = '';
if (replyToId) {
const repliedMsg = this.messages.find(m => m.id === replyToId);
if (repliedMsg) {
const replyText = repliedMsg.text.substring(0, 50) + (repliedMsg.text.length > 50 ? '...' : '');
replyPreview = `<div class="message-reply-preview">‚Ü≥ ${this.escapeHtml(replyText)}</div>`;
}
}

messageDiv.innerHTML = `
${replyPreview}
<div class="message-text">${this.escapeHtml(text)}</div>
<div class="message-time">${time}</div>
${sender === 'operator' ? `<div class="message-actions"><button type="button" class="message-action-btn" data-reply-id="${messageDiv.dataset.messageId}">–û—Ç–≤–µ—Ç–∏—Ç—å</button></div>` : ''}
`;

if (sender === 'operator') {
const replyBtn = messageDiv.querySelector('.message-action-btn');
if (replyBtn) {
replyBtn.addEventListener('click', (e) => {
e.preventDefault();
e.stopPropagation();
this.setReply(messageDiv.dataset.messageId, text);
});
} else {
console.warn('‚ö†Ô∏è –ö–Ω–æ–ø–∫–∞ "–û—Ç–≤–µ—Ç–∏—Ç—å" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è:', messageDiv.dataset.messageId);
}
}

chatMessages.appendChild(messageDiv);
this.scrollToBottom();

const messageObj = {
id: messageDiv.dataset.messageId,
text: text,
sender: sender,
replyToId: replyToId,
timestamp: new Date().toISOString()
};

this.messages.push(messageObj);
this.saveMessagesToStorage();

if (sender === 'operator' && !document.getElementById('chatModal').classList.contains('active')) {
this.showBadge();
}
}

setReply(messageId, messageText) {
this.selectedReplyId = messageId;
const previewBox = document.getElementById('replyPreviewBox');
const previewText = document.getElementById('replyPreviewText');

const shortText = messageText.substring(0, 60) + (messageText.length > 60 ? '...' : '');
previewText.textContent = `–û—Ç–≤–µ—Ç –Ω–∞: ${shortText}`;
previewBox.style.display = 'flex';

document.getElementById('chatInput').focus();
}

clearReply() {
this.selectedReplyId = null;
document.getElementById('replyPreviewBox').style.display = 'none';
}

addSystemMessage(text) {
const chatMessages = document.getElementById('chatMessages');
const messageDiv = document.createElement('div');
messageDiv.className = 'chat-message message-operator';
messageDiv.style.backgroundColor = 'rgba(212, 175, 55, 0.1)';
messageDiv.style.color = 'var(--primary)';
messageDiv.style.fontStyle = 'italic';
messageDiv.style.fontSize = '13px';

messageDiv.innerHTML = `
<div class="message-text">${this.escapeHtml(text)}</div>
`;

chatMessages.appendChild(messageDiv);
this.scrollToBottom();
}

async loadChatHistory() {
try {
console.log('üì• –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ –¥–ª—è:', this.chatKey);

const response = await fetch(`https://roomix-production.up.railway.app/chat_history/${this.chatKey}`);

if (response.ok) {
const data = await response.json();
console.log('üì¶ –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞:', data.messages?.length || 0, '—Å–æ–æ–±—â–µ–Ω–∏–π');

if (data.messages && data.messages.length > 0) {
data.messages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —É–∂–µ –µ—Å—Ç—å –≤ DOM, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å
const existingIds = new Set();
const chatMessages = document.getElementById('chatMessages');
if (chatMessages) {
chatMessages.querySelectorAll('.chat-message').forEach(msgEl => {
const msgId = msgEl.dataset.messageId;
if (msgId) existingIds.add(msgId);
});
}

// –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
let newMessagesCount = 0;
data.messages.forEach(msg => {
// –ò—Å–ø–æ–ª—å–∑—É–µ–º msg.id –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ —Å–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π id
const msgId = msg.id || `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
if (!existingIds.has(msgId)) {
this.addMessage(msg.text, msg.sender, msgId, msg.reply_to_message_id);
newMessagesCount++;
}
});
if (newMessagesCount > 0) {
console.log(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ ${newMessagesCount} –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏`);
}
} else {
this.addSystemMessage('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —á–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏! –ß–µ–º –º–æ–∂–µ–º –ø–æ–º–æ—á—å?');
}
} else {
throw new Error(`HTTP ${response.status}`);
}
} catch (error) {
console.error('‚ùå –û—à–∏–±ÔøΩÔøΩ–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞:', error);
this.addSystemMessage('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —á–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏! –ß–µ–º –º–æ–∂–µ–º –ø–æ–º–æ—á—å?');
}
}

connectSSE() {
// –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
if (this.reconnectTimeout) {
clearTimeout(this.reconnectTimeout);
this.reconnectTimeout = null;
}

// –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
if (this.eventSource) {
try {
this.eventSource.close();
} catch (e) {
// –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
}
this.eventSource = null;
}

try {
console.log('üîó –ü–æ–¥–∫–ª—é—á–∞–µ–º SSE –¥–ª—è:', this.chatKey);

this.eventSource = new EventSource(`https://roomix-production.up.railway.app/sse/${this.chatKey}`);

this.eventSource.onopen = () => {
console.log('‚úÖ SSE –ø–æ–¥–∫–ª—é—á–µ–Ω');
this.isConnected = true;
const wasReconnecting = this.reconnectAttempts > 0;
this.reconnectAttempts = 0;
this.lastHeartbeat = Date.now();
if (this.reconnectTimeout) {
clearTimeout(this.reconnectTimeout);
this.reconnectTimeout = null;
}
// –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
if (wasReconnecting) {
setTimeout(() => {
this.loadChatHistory();
}, 500);
}
};

this.eventSource.onmessage = (event) => {
try {
const data = JSON.parse(event.data);
console.log('üì® –ü–æ–ª—É—á–µ–Ω–æ SSE —Å–æ–æ–±—â–µ–Ω–∏–µ:', data);

// –û–±–Ω–æ–≤–ª—è–µ–º heartbeat –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ª—é–±–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
this.lastHeartbeat = Date.now();

if (data.type === 'chat_message' || (data.type === 'operator_reply' && data.message)) {
// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
const messageText = data.message || data.text || '';
const messageId = data.message_id || `msg_${Date.now()}`;
const replyToId = data.reply_to_message_id || null;
if (messageText) {
this.addMessage(messageText, 'operator', messageId, replyToId);
console.log('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –¥–æ–±–∞–≤–ª–µ–Ω–æ –≤ —á–∞—Ç:', messageText.substring(0, 50));
} else {
console.warn('‚ö†Ô∏è –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –±–µ–∑ —Ç–µ–∫—Å—Ç–∞:', data);
}
} else if (data.type === 'system') {
this.addSystemMessage(data.message);
} else if (data.type === 'ping' || data.type === 'heartbeat') {
// –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º ping —Å–æ–æ–±—â–µ–Ω–∏—è, –Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º heartbeat
console.log('üíì Heartbeat –ø–æ–ª—É—á–µ–Ω');
} else {
console.log('‚ÑπÔ∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø SSE —Å–æ–æ–±—â–µ–Ω–∏—è:', data.type, data);
}
} catch (error) {
console.error('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ SSE –¥–∞–Ω–Ω—ã—Ö:', error);
}
};

this.eventSource.onerror = (error) => {
// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –ü–ï–†–ï–î –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–∫–∏
const readyState = this.eventSource ? this.eventSource.readyState : EventSource.CLOSED;
console.log(`üîç SSE onerror –≤—ã–∑–≤–∞–Ω, —Å–æ—Å—Ç–æ—è–Ω–∏–µ: ${readyState} (0=CONNECTING, 1=OPEN, 2=CLOSED)`);

// –ï—Å–ª–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –µ—â–µ –æ—Ç–∫—Ä—ã—Ç–æ (readyState === 1), –Ω–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è
// –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—Ä–µ–º–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏, –Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
if (readyState === EventSource.OPEN) {
console.log('‚ÑπÔ∏è –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É (–≤–æ–∑–º–æ–∂–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Å–µ—Ç–∏)');
return; // –ù–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è, –µ—Å–ª–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ
}

// –ï—Å–ª–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ –∏–ª–∏ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∑–∞–∫—Ä—ã—Ç–∏—è, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è
if (readyState === EventSource.CLOSED) {
console.error('‚ùå SSE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è...');
this.isConnected = false;

// –ë–ï–°–ö–û–ù–ï–ß–ù–û–ï –ü–ï–†–ï–ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï —Å –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–µ–π
this.reconnectAttempts++;
const baseDelay = 500;
const maxDelay = 10000;
const delay = Math.min(baseDelay * Math.pow(1.3, this.reconnectAttempts - 1), maxDelay);
console.log(`üîÑ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ ${delay}ms... (–ø–æ–ø—ã—Ç–∫–∞ ${this.reconnectAttempts})`);

if (this.reconnectAttempts === 1) {
this.addSystemMessage('–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
}

// –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
if (this.eventSource) {
try {
this.eventSource.close();
} catch (e) {
// –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
}
this.eventSource = null;
}

// –ü–ª–∞–Ω–∏—Ä—É–µ–º –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
if (this.reconnectAttempts === 1) {
setTimeout(() => {
this.connectSSE();
}, 100);
} else {
this.reconnectTimeout = setTimeout(() => {
this.connectSSE();
}, delay);
}
} else if (readyState === EventSource.CONNECTING) {
console.log('‚ÑπÔ∏è –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏, –∂–¥–µ–º...');
// –ù–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è, –µ—Å–ª–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –µ—â–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
}
};
} catch (error) {
console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è SSE:', error);
this.isConnected = false;
// –ü–ª–∞–Ω–∏—Ä—É–µ–º –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
this.reconnectAttempts++;
const delay = Math.min(1000 * Math.pow(1.5, this.reconnectAttempts - 1), 30000);
this.reconnectTimeout = setTimeout(() => {
this.connectSSE();
}, delay);
}
}

showBadge() {
const badge = document.getElementById('chatBadge');
badge.style.display = 'flex';
}

hideBadge() {
const badge = document.getElementById('chatBadge');
badge.style.display = 'none';
}

scrollToBottom() {
const chatMessages = document.getElementById('chatMessages');
if (chatMessages) {
// –ò—Å–ø–æ–ª—å–∑—É–µ–º requestAnimationFrame –¥–ª—è –ø–ª–∞–≤–Ω–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
requestAnimationFrame(() => {
chatMessages.scrollTop = chatMessages.scrollHeight;
// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
setTimeout(() => {
chatMessages.scrollTop = chatMessages.scrollHeight;
}, 50);
});
}
}

escapeHtml(text) {
const div = document.createElement('div');
div.textContent = text;
return div.innerHTML;
}

saveMessagesToStorage() {
try {
const storageKey = `chat_messages_${this.chatKey}`;
localStorage.setItem(storageKey, JSON.stringify(this.messages));
} catch (error) {
console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
}
}

loadMessagesFromStorage() {
try {
const storageKey = `chat_messages_${this.chatKey}`;
const saved = localStorage.getItem(storageKey);
if (saved) {
const messages = JSON.parse(saved);
const chatMessages = document.getElementById('chatMessages');
if (chatMessages) {
// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —É–∂–µ –µ—Å—Ç—å –≤ DOM
const existingIds = new Set();
chatMessages.querySelectorAll('.chat-message').forEach(msgEl => {
const msgId = msgEl.dataset.messageId;
if (msgId) existingIds.add(msgId);
});

// –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã—Ö –µ—â–µ –Ω–µ—Ç –≤ DOM
messages.forEach(msg => {
if (!existingIds.has(msg.id)) {
this.messages.push(msg);
// –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ UI
const messageDiv = document.createElement('div');
messageDiv.className = `chat-message message-${msg.sender}`;
messageDiv.dataset.messageId = msg.id;

const time = new Date(msg.timestamp).toLocaleTimeString('ru-RU', {
hour: '2-digit',
minute: '2-digit'
});

let replyPreview = '';
if (msg.replyToId) {
const repliedMsg = messages.find(m => m.id === msg.replyToId);
if (repliedMsg) {
const replyText = repliedMsg.text.substring(0, 50) + (repliedMsg.text.length > 50 ? '...' : '');
replyPreview = `<div class="message-reply-preview">‚Ü≥ ${this.escapeHtml(replyText)}</div>`;
}
}

messageDiv.innerHTML = `
${replyPreview}
<div class="message-text">${this.escapeHtml(msg.text)}</div>
<div class="message-time">${time}</div>
${msg.sender === 'operator' ? `<div class="message-actions"><button type="button" class="message-action-btn" data-reply-id="${msg.id}">–û—Ç–≤–µ—Ç–∏—Ç—å</button></div>` : ''}
`;

if (msg.sender === 'operator') {
const btn = messageDiv.querySelector('.message-action-btn');
if (btn) {
btn.addEventListener('click', (e) => {
e.preventDefault();
e.stopPropagation();
this.setReply(msg.id, msg.text);
});
} else {
console.warn('‚ö†Ô∏è –ö–Ω–æ–ø–∫–∞ "–û—Ç–≤–µ—Ç–∏—Ç—å" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞:', msg.id);
}
}

chatMessages.appendChild(messageDiv);
}
});
this.scrollToBottom();
}
}
} catch (error) {
console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞:', error);
}
}

startHeartbeat() {
// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 20 —Å–µ–∫—É–Ω–¥ (—á–∞—â–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º)
this.heartbeatInterval = setInterval(() => {
if (this.isConnected && this.lastHeartbeat) {
const timeSinceLastHeartbeat = Date.now() - this.lastHeartbeat;
// –ï—Å–ª–∏ –ø—Ä–æ—à–ª–æ –±–æ–ª—å—à–µ 45 —Å–µ–∫—É–Ω–¥ –±–µ–∑ heartbeat (3 –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞ –ø–æ 15 —Å–µ–∫), —Å—á–∏—Ç–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–Ω—ã–º
if (timeSinceLastHeartbeat > 45000) {
console.warn(`‚ö†Ô∏è Heartbeat timeout (${Math.round(timeSinceLastHeartbeat/1000)}s), –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è...`);
this.isConnected = false;
if (this.eventSource) {
try {
this.eventSource.close();
} catch (e) {}
this.eventSource = null;
}
// –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
this.reconnectAttempts = 0;
this.connectSSE();
}
} else if (!this.isConnected && !this.eventSource) {
// –ï—Å–ª–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ –∞–∫—Ç–∏–≤–Ω–æ –∏ –Ω–µ—Ç eventSource, –ø—ã—Ç–∞–µ–º—Å—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
console.log('üîÑ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ –∞–∫—Ç–∏–≤–Ω–æ, –ø—ã—Ç–∞–µ–º—Å—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è...');
this.reconnectAttempts = 0;
this.connectSSE();
}
}, 20000);
}

setupPageEvents() {
// –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
window.addEventListener('pageshow', (event) => {
if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
console.log('üîÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–∑ –∫—ç—à–∞, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è...');
if (!this.isConnected || !this.eventSource) {
this.connectSSE();
}
}
});

// –ü—Ä–∏ —É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é
window.addEventListener('beforeunload', () => {
// –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ, —á—Ç–æ–±—ã –æ–Ω–æ –º–æ–≥–ª–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è
// –ü—Ä–æ—Å—Ç–æ –æ—á–∏—â–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
if (this.heartbeatInterval) {
clearInterval(this.heartbeatInterval);
}
if (this.reconnectTimeout) {
clearTimeout(this.reconnectTimeout);
}
});

// –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –æ–∫–Ω–∞
window.addEventListener('focus', () => {
if (!this.isConnected || !this.eventSource || this.eventSource.readyState === EventSource.CLOSED) {
console.log('üîÑ –û–∫–Ω–æ –ø–æ–ª—É—á–∏–ª–æ —Ñ–æ–∫—É—Å, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...');
this.connectSSE();
}
});

// –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('visibilitychange', () => {
if (!document.hidden) {
if (!this.isConnected || !this.eventSource || this.eventSource.readyState === EventSource.CLOSED) {
console.log('üîÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å—Ç–∞–ª–∞ –≤–∏–¥–∏–º–æ–π, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...');
this.connectSSE();
}
}
});
}

destroy() {
if (this.heartbeatInterval) {
clearInterval(this.heartbeatInterval);
this.heartbeatInterval = null;
}
if (this.reconnectTimeout) {
clearTimeout(this.reconnectTimeout);
this.reconnectTimeout = null;
}
if (this.eventSource) {
try {
this.eventSource.close();
} catch (e) {
// –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
}
this.eventSource = null;
}
}
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞
function initSupportChat() {
window.supportChat = new SupportChat();
}

// –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–º –∑–∞–∫—Ä—ã—Ç–∏–∏, –Ω–µ –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏)
window.addEventListener('beforeunload', () => {
// –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é, —á—Ç–æ–±—ã –æ–Ω–æ –º–æ–≥–ª–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è
// –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –±—É–¥—É—Ç –æ—á–∏—â–µ–Ω—ã –≤ –º–µ—Ç–æ–¥–µ destroy –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
});
</script>

</body>
</html>
